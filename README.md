# aton-statement-parser

–ü–∞–∫–µ—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ XML-–æ—Ç—á—ë—Ç–æ–≤ –±—Ä–æ–∫–µ—Ä–∞ **–ê—Ç–æ–Ω** (—Ñ–æ—Ä–º–∞—Ç `BIS:BISPeriod`) –≤ —É–¥–æ–±–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ –º–æ–∂–Ω–æ –±—ã–ª–æ:

* –ø–µ—Ä–µ–¥–∞—Ç—å –ø—É—Ç—å –¥–æ XML-—Ñ–∞–π–ª–∞,
* –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä–µ–∫—Ç –æ—Ç—á—ë—Ç–∞ (`Report`),
* –±—ã—Å—Ç—Ä–æ –≤—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–π –±–ª–æ–∫ (`Trades`, `MoneyInOut`, `StockInOut`, ‚Ä¶),
* –Ω–∞–π—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏—é –ø–æ `OperID`,
* —Å–æ–±—Ä–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö `OperID` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —Å–≤–µ—Ä–∫–∏ —Å –ë–î),
* —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ —Å—Ç—Ä–æ–∫ —á–µ—Ä–µ–∑ —É–¥–æ–±–Ω—ã–µ –≥–µ—Ç—Ç–µ—Ä—ã (—Å—Ç—Ä–æ–∫–∏/–¥–∞—Ç—ã/—á–∏—Å–ª–∞) –±–µ–∑ ¬´–º–∞–≥–∏—á–µ—Å–∫–∏—Ö¬ª –∏–Ω–¥–µ–∫—Å–æ–≤ –º–∞—Å—Å–∏–≤–∞.

> –¶–µ–ª—å: –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –±–æ–ª—å –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –æ—Ç—á—ë—Ç–∞–º–∏ (namespaces, windows-1251, —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç, –¥—Ä–æ–±–Ω—ã–µ —á–∏—Å–ª–∞).

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–ø–ª–∞–Ω–∏—Ä—É–µ–º—ã–π API)

```php
use MasyaSmv\AtonStatementParser\AtonStatementParser;

$report = AtonStatementParser::fromFile('/path/to/report.xml');

// –î–æ—Å—Ç—É–ø –∫ —Å–µ–∫—Ü–∏—è–º (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ)
$trades = $report->section('Trades')->rows();      // Row[]
$money  = $report->section('MoneyInOut')->rows();  // Row[]

// –ü–æ–∏—Å–∫ –ø–æ OperID
$row = $report->findOperId('567890123');           // Row|null

// –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö OperID (–¥–ª—è —Å–≤–µ—Ä–∫–∏)
$ids = $report->operIds();                         // array<int|string>

// –£–¥–æ–±–Ω—ã–µ –≥–µ—Ç—Ç–µ—Ä—ã –∞—Ç—Ä–∏–±—É—Ç–æ–≤
$type = $report->section('Trades')->rows()[0]->getString('TradeType');
$date = $report->section('Trades')->rows()[0]->getDate('OperDateSort'); // DateTimeImmutable|null
```

---

## –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ—à–∞–µ—Ç –ø–∞–∫–µ—Ç

### 1) Namespace BIS

XML –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `xmlns:BIS=...`, –∑–Ω–∞—á–∏—Ç –Ω–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ ¬´–ø–æ –∏–º–µ–Ω–∏ —Ç–µ–≥–∞¬ª ‚Äî –Ω—É–∂–µ–Ω XPath —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π namespace.

### 2) –ö–æ–¥–∏—Ä–æ–≤–∫–∞ windows-1251

–í —à–∞–ø–∫–µ –æ—Ç—á—ë—Ç–∞ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è `encoding="windows-1251"`. –ü–∞–∫–µ—Ç –¥–æ–ª–∂–µ–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç –≤ UTF-8 –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º.

### 3) –†–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç

–í –æ—Ç—á—ë—Ç–∞—Ö –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è:

* `29.12.2023`
* `02.10.24`
* `16.11.18`
* `26.12.24 / ` (–º—É—Å–æ—Ä–Ω—ã–µ —Ö–≤–æ—Å—Ç—ã)

–ù—É–∂–µ–Ω –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–∞—Ç—ã: —Ç—Ä–∏–º + –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `d.m.Y` –∏ `d.m.y`.

### 4) –î–µ—Å—è—Ç–∏—á–Ω—ã–µ —á–∏—Å–ª–∞

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Å—É–º–º—ã ‚Äî —Å—Ç—Ä–æ–∫–∏ —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é (`100000.00000000`). –ë–∞–∑–æ–≤—ã–π —Å–ª–æ–π —Ö—Ä–∞–Ω–∏—Ç –∫–∞–∫ string, –∞ –≥–µ—Ç—Ç–µ—Ä—ã —É–º–µ—é—Ç –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ float/int –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–∫–∞–∫ –ø–ª–∞–Ω–∏—Ä—É–µ–º)

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏

* **Report** ‚Äî –≤–µ—Å—å –æ—Ç—á—ë—Ç, –¥–æ—Å—Ç—É–ø –∫ —Å–µ–∫—Ü–∏—è–º –∏ –æ–±—â–∏–º –¥–∞–Ω–Ω—ã–º.
* **Section** ‚Äî –æ–¥–∏–Ω –±–ª–æ–∫ –≤–Ω—É—Ç—Ä–∏ –æ—Ç—á—ë—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä `Trades`, `MoneyInOut`).
* **Row** ‚Äî –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ `<BIS:Row .../>` –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–∏. –•—Ä–∞–Ω–∏—Ç –∞—Ç—Ä–∏–±—É—Ç—ã + —Ç–∏–ø–æ–≤—ã–µ –≥–µ—Ç—Ç–µ—Ä—ã.

### –£—Ä–æ–≤–Ω–∏ —É–¥–æ–±—Å—Ç–≤–∞

1. **–ë–∞–∑–æ–≤—ã–π (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)**: `Report/Section/Row` ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ª—é–±—ã—Ö —Å–µ–∫—Ü–∏–π –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ—Å—è—Ç–∫–æ–≤ DTO.
2. **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π (DTO –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–µ–∫—Ü–∏–π)**: `TradeDto`, `MoneyInOutDto` –∏ —Ç.–ø. ‚Äî –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ, –∫–æ–≥–¥–∞ —Å—Ç–∞–Ω–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–ø–ª–∞–Ω)

```text
src/
  AtonStatementParser.php          // fromFile/fromString
  Report/
    Report.php                     // —Å–µ–∫—Ü–∏–∏ + commonData
    Section.php                    // –∏–º—è —Å–µ–∫—Ü–∏–∏ + Row[]
    Row.php                        // –∞—Ç—Ä–∏–±—É—Ç—ã BIS:Row + –≥–µ—Ç—Ç–µ—Ä—ã
  Xml/
    XmlLoader.php                  // —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞, encoding -> utf8, DOM
    XPathFactory.php               // DOMXPath + —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è namespace
  Normalizers/
    DateNormalizer.php             // –¥–∞—Ç—ã (d.m.y / d.m.Y, –º—É—Å–æ—Ä–Ω—ã–µ —Ö–≤–æ—Å—Ç—ã)
    NumberNormalizer.php           // —á–∏—Å–ª–∞/–¥–µ—Å—è—Ç–∏—á–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
    StringNormalizer.php           // trim/cleanup
  Exceptions/
    ParseException.php
    InvalidXmlException.php

tests/
  Fixtures/
    aton/
      ...xml
  ...
```

---

## Roadmap / –ü–ª–∞–Ω —Ä–∞–±–æ—Ç

### ‚úÖ –£–∂–µ —Å–¥–µ–ª–∞–Ω–æ

- [x] –ë–∞–∑–æ–≤—ã–π –∫–∞—Ä–∫–∞—Å –ø–∞–∫–µ—Ç–∞ (autoload, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã)
- [x] Fixtures –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –≤ —Ç–µ—Å—Ç—ã
- [x] Composer scripts: `test`, `cs:*`, `stan`

#### –≠—Ç–∞–ø A ‚Äî ¬´—Å—Ä–∞–∑—É –ø–æ–ª–µ–∑–Ω–æ¬ª (—è–¥—Ä–æ –ø–∞—Ä—Å–∏–Ω–≥–∞)
- [x] `AtonStatementParser::fromFile(string $path): Report`
- [x] `AtonStatementParser::fromString(string $xml): Report`
- [x] `Report->section(string $name): Section`
- [x] `Section->rows(): array<Row>`
- [x] `Report->operIds(): array` (—Å–æ–±—Ä–∞—Ç—å `OperID` –ø–æ —Å–µ–∫—Ü–∏—è–º)
- [x] `Report->findOperId(string $id): ?Row`
- [x] Unit-—Ç–µ—Å—Ç—ã –Ω–∞ fixtures (operIds/findOperId/section)

#### –≠—Ç–∞–ø B ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∏–ø–æ–≤ (typed getters)
- [x] `Row->getString($key)`
- [x] `Row->getInt($key)`
- [x] `Row->getFloat($key)`
- [x] `Row->getDecimalString($key)` (–±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏)
- [x] `Row->getBool($key)`
- [x] `Row->getDate($key): ?DateTimeImmutable`
- [x] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–∞—Ç/–≤—Ä–µ–º–µ–Ω–∏ –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤:
  - [x] `dd.mm.yy` ‚Üí —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–æ `dd.mm.yyyy`
  - [x] `OperDateSort="dd.mm.yyyy 0:00:00"` (–≤—Ä–µ–º—è –≤—Å–µ–≥–¥–∞ 00:00:00)
  - [x] `OperTimeSort="01.01.1900 HH:ii:ss"` (–¥–∞—Ç–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è, –≤–∞–∂–Ω–æ –≤—Ä–µ–º—è)
  - [x] –∑–Ω–∞—á–µ–Ω–∏—è –≤–∏–¥–∞ `26.12.24 / ` (—á–∏—Å—Ç–∫–∞ –º—É—Å–æ—Ä–∞)
  - [x] —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã –±–µ–∑ ‚Äú—Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏‚Äù (—á–µ—Ä–µ–∑ `!` –≤ —Ñ–æ—Ä–º–∞—Ç–∞—Ö)
- [x] –¢–µ—Å—Ç—ã –Ω–∞ –¥–∞—Ç—ã/—á–∏—Å–ª–∞ + —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π fixture

---

### üöß –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ

#### –≠—Ç–∞–ø C ‚Äî –¥–æ–º–µ–Ω–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ (—É–¥–æ–±–Ω—ã–π API –±–µ–∑ —Ä–∞–∑–¥—É–≤–∞–Ω–∏—è Row)
- [ ] `Row->getStringRequired()` / `getIntRequired()` / `getDecimalStringRequired()` / `getDateRequired()` (–∫–∏–¥–∞—é—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º)
- [ ] –î–æ–º–µ–Ω–Ω—ã–µ ‚Äú–æ–±—ë—Ä—Ç–∫–∏‚Äù –ø–æ —Å–µ–∫—Ü–∏—è–º:
  - [ ] `TradeRow` (—Å–µ–∫—Ü–∏—è `Trades`)
  - [ ] `MoneyInOutRow` (—Å–µ–∫—Ü–∏—è `MoneyInOut`)
  - [ ] `StockInOutRow` (—Å–µ–∫—Ü–∏—è `StockInOut`)
  - [ ] `ClientMoneyConvertRow` (—Å–µ–∫—Ü–∏—è `ClientMoneyConvert`)
- [ ] –°–∞—Ö–∞—Ä –Ω–∞ —É—Ä–æ–≤–Ω–µ `Report/Section`:
  - [ ] `Report->trades(): array<TradeRow>` (–∏–ª–∏ `section('Trades')->asTrades()`)
  - [ ] `Report->moneyInOut(): array<MoneyInOutRow>`
- [ ] –¢–µ—Å—Ç—ã –¥–æ–º–µ–Ω–Ω—ã—Ö —Å–µ–∫—Ü–∏–π

#### –≠—Ç–∞–ø D ‚Äî DTO (—Ç–æ—á–µ—á–Ω–æ, —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ)
- [ ] `TradeDto`, `MoneyInOutDto` (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –ø–æ–ª–µ–π, –Ω—É–∂–Ω—ã–π –ø—Ä–æ–µ–∫—Ç—É)
- [ ] –ú–∞–ø–ø–µ—Ä—ã —Å–µ–∫—Ü–∏–π ‚Üí DTO (—á–µ—Ä–µ–∑ –¥–æ–º–µ–Ω–Ω—ã–µ row-–æ–±—ë—Ä—Ç–∫–∏)
- [ ] –¢–µ—Å—Ç—ã DTO-–º–∞–ø–ø–∏–Ω–≥–∞ (–≤–∞–ª–∏–¥–Ω—ã–µ/–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è)

#### –≠—Ç–∞–ø E ‚Äî —É–¥–æ–±—Å—Ç–≤–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ—Ç—á—ë—Ç–æ–≤
- [ ] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è/–ø–æ–∏—Å–∫ –ø–æ —Å–µ–∫—Ü–∏–∏:
  - [ ] `section()->filter(fn(Row $r) => ...)`
  - [ ] `section()->firstWhere(...)`
- [ ] –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø–æ `OperID` (–ª–µ–Ω–∏–≤–æ –∏–ª–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ)
- [ ] –£–ª—É—á—à–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ (–∫–æ–Ω—Ç–µ–∫—Å—Ç: —Å–µ–∫—Ü–∏—è, –∫–ª—é—á, –∑–Ω–∞—á–µ–Ω–∏–µ)
- [ ] (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–¥ –±–æ–ª—å—à–∏–µ XML (–µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)

---

## Fixtures –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

* –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∫–æ–º–º–∏—Ç–∏–º **—Ç–æ–ª—å–∫–æ –æ–±–µ–∑–ª–∏—á–µ–Ω–Ω—ã–µ** XML.
* –†–µ–∞–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏ ‚Äî –¥–µ—Ä–∂–∞—Ç—å –≤ `tests/FixturesLocal/` (–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ `.gitignore`).

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å `.gitattributes`, —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å ¬´–Ω–µ–≤–∏–¥–∏–º—ã–µ¬ª –ø—Ä–∞–≤–∫–∏ –∫–æ–Ω—Ü–æ–≤ —Å—Ç—Ä–æ–∫ (LF/CRLF).

---

## Installation

```bash
composer require masyasmv/aton-statement-parser
```

---

## Development

```bash
composer install
composer test
composer cs:fix
composer cs:check
composer stan
```

---

## License

MIT. –°–º. —Ñ–∞–π–ª [LICENSE](LICENSE).
